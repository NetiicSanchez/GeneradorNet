<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial Despacho</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div class="contenedor">
    <h1>Historial de Códigos NET</h1>
    <input type="text" id="buscar" placeholder="Buscar por NET o cliente...">
    <ul id="historial"></ul>
    <div id="paginacion">
      <button id="anterior">Anterior</button>
      <span id="pagina-actual"></span>
      <button id="siguiente">Siguiente</button>
    </div>
  </div>

  <script>
    let paginaActual = 1;
    let busquedaActual = '';

    const historialUl = document.getElementById('historial');
    const buscarInput = document.getElementById('buscar');
    const paginacionDiv = document.getElementById('paginacion');
    const paginaActualSpan = document.getElementById('pagina-actual');
    const anteriorBtn = document.getElementById('anterior');
    const siguienteBtn = document.getElementById('siguiente');

    async function cargarHistorial(page = 1, query = '') {
      try {
        const url = `/buscar-imagenes?q=${query}&page=${page}`;
        const res = await fetch(url);
        const data = await res.json();

        historialUl.innerHTML = ''; // Limpiar lista

        if (data.imagenes && data.imagenes.length > 0) {
          data.imagenes.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `
              <strong>${item.codigo_net}</strong><br>
              Cliente: ${item.nombre_cliente}<br>
              Coordenadas: ${item.coordenadas || ''}<br>
              <img src="${item.foto}" alt="Foto del cliente" loading="lazy" style="max-width:200px;max-height:200px;"><br>
              <a href="${item.foto}" target="_blank">Ver foto</a>
            `;
            historialUl.appendChild(li);
          });
          paginacionDiv.style.display = 'block';
        } else {
          historialUl.innerHTML = '<li>No se encontraron resultados.</li>';
          paginacionDiv.style.display = 'none';
        }

        // Actualizar estado de paginación
        paginaActual = data.paginaActual || 1;
        busquedaActual = query;
        paginaActualSpan.textContent = `Página ${paginaActual} de ${data.paginas || 1}`;
        anteriorBtn.disabled = paginaActual <= 1;
        siguienteBtn.disabled = paginaActual >= (data.paginas || 1);

      } catch (err) {
        console.error('Error al cargar historial:', err);
        historialUl.innerHTML = '<li>Error al cargar los datos.</li>';
      }
    }

    // Evento para el buscador (con debounce para no hacer peticiones en cada tecla)
    let debounceTimeout;
    buscarInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => {
        cargarHistorial(1, e.target.value);
      }, 300); // Espera 300ms después de que el usuario deja de escribir
    });

    // Eventos para paginación
    anteriorBtn.addEventListener('click', () => {
      if (paginaActual > 1) {
        cargarHistorial(paginaActual - 1, busquedaActual);
      }
    });

    siguienteBtn.addEventListener('click', () => {
      cargarHistorial(paginaActual + 1, busquedaActual);
    });

    // Carga inicial
    document.addEventListener('DOMContentLoaded', () => {
      cargarHistorial();
    });
  </script>
</body>
</html>